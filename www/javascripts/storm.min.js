(function(){var t,e,n=function(t,e){return function(){return t.apply(e,arguments)}};window.Storm=t={},t.bolts={},t.keywords={},t.env={production:"stormbar.net"===window.location.hostname,development:"stormbar.net"!==window.location.hostname,server:this.production?"stormbar.net":"localhost:9000"},t.init=function(e){var n;return n=URI(window.location.href).query(!0),new t.Bar($(e),{query:n.q}),t.loadAllFromIndex()},t.boltURL=function(t){var e;return 0===t.search(/^https?:\/\//i)?t:0===t.search(/^dev\//)?(e=t.split("/")[1],"http://localhost:9001/"+e+"/"+e+".bolt.coffee"):0===t.search(/^\//)?t:"http://raw.github.com/stormbar/bolts/master/"+t+"/"+t+".bolt.coffee"},t.maybeInstall=function(e){return t.isInstalled(t.idFromURL(e))?void 0:t.install(e)},t.install=function(e){return t.activity("installing bolt",function(n){return e=t.boltURL(e),0===e.search(/^\//i)?$.get(e,null,function(r){return t.load(e,r,{isPrivileged:!0,isInstall:!0}),n.end()},"text"):0===e.search(/^http:\/\/localhost/)?$.get(e,null,function(r){return t.load(e,r,{isPrivileged:!1,isInstall:!0}),n.end()},"text"):$.getJSON("http://anyorigin.com/get?callback=?&url="+e,function(r){return t.load(e,r.contents,{isPrivileged:!1,isInstall:!0}),n.end()})})},t.idFromURL=function(t){return""+CryptoJS.SHA1(t)},t.load=function(e,n,r){var i;return null==r&&(r={}),i=new t.Bolt(e,n,r.isPrivileged||!1),t.register(i,r.isInstall||!1),r.isInstall&&i.install(),i},t.register=function(e,n){return null==n&&(n=!1),t.bolts[e.id]=e,t.keywords[e.getKeyword()]=t.keywords[e.getKeyword()]||[],-1===$.inArray(e.id,t.keywords[e.getKeyword()])&&t.keywords[e.getKeyword()].push(e.id),n&&t.addToIndex(e),e},t.update=function(e){var n;return n=t.bolts[e],t.install(n.url)},t.updateAll=function(){var e,n,r,i;r=t.bolts,i=[];for(n in r)e=r[n],i.push(t.install(e.url));return i},t.uninstall=function(e){var n;return n=t.bolts[e],n.uninstall(),t.removeFromIndex(n),delete t.bolts[e],t.keywords[n.getKeyword()]=t.keywords[n.getKeyword()].filter(function(t){return t!==e})},t.removeFromIndex=function(e){var n;return t.store.remove(["bolt",e.id]),n=t.store.get("bolts",{}),n.installed=n.installed||[],n.installed=n.installed.filter(function(t){return t!==e.id}),t.store.set("bolts",n)},t.addToIndex=function(e){var n;return t.store.set(["bolt",e.id],{url:e.url,isPrivileged:e.isPrivileged,source:e.source}),n=t.store.get("bolts",{}),n.installed=n.installed||[],-1===$.inArray(e.id,n.installed)&&n.installed.push(e.id),t.store.set("bolts",n)},t.loadAllFromIndex=function(){var e,n,r,i,o,s;if(n=t.store.get("bolts",{}),n.installed){for(o=n.installed,s=[],r=0,i=o.length;i>r;r++)e=o[r],s.push(t.loadFromIndex(e));return s}},t.loadFromIndex=function(e){var n;return(n=t.store.get(["bolt",e]))?t.load(n.url,n.source,{isInstall:!1,isPrivileged:n.isPrivileged}):void 0},t.isInstalled=function(e){var n;return n=t.store.get("bolts",{}),n.installed?-1!==$.inArray(e,n.installed):!1},t.terminateAll=function(){var e,n,r,i;r=t.bolts,i=[];for(n in r)e=r[n],i.push(e.terminate());return i},t.activity=function(e,n){var r;return r=t.ActivityManager.create(),r.start(e),n(r)},t.utils={prefixMatch:function(t,e){return 0===e.search(RegExp("^"+t,"i"))},fuzzyMatch:function(t,e,n){return null==n&&(n=0),e.score(t)>n}},t.actions={repeat:function(){return function(t){return t.update(!0)}},open:function(t){return function(){return window.open(t)}},image:function(e,n){return function(){return new t.Modal("image",{title:n,image:e}).open()}},iframe:function(e){return function(){return new t.Modal("iframe",{src:e}).open()}},fill:function(t){return function(e){return e.forceSearchTerm(t)}},fillKeyword:function(t){return function(e){return e.forceSearchTerm(t+" ")}},fillCommand:function(t,e){return function(n){return n.forceSearchTerm(""+t+" "+e+" ")}},reset:function(){return function(t){return t.reset()}},ignore:function(){return function(){return null}},install:function(e){return function(n){return this.isPrivileged?(t.install(e),n.reset()):void 0}},uninstall:function(e){return function(n){return this.isPrivileged?(t.uninstall(e),n.reset()):void 0}},update:function(e){return function(n){return this.isPrivileged?(t.update(e),n.reset()):void 0}},updateAll:function(){return function(e){return this.isPrivileged?(t.updateAll(),e.reset()):void 0}}},t.ActivityManager={activities:[],indicatorShowing:!1,hasRunningActivities:!1,create:function(){var e;return e=new t.Activity(this),this.activities.push(e),e},update:function(){var t;return this.activities=function(){var e,n,r,i;for(r=this.activities,i=[],e=0,n=r.length;n>e;e++)t=r[e],t.isRunning()&&i.push(t);return i}.call(this),this.hasRunningActivities=this.activities.length>0,this.updateIndicator()},updateIndicator:function(){var t;return t=$("#activity-indicator"),this.hasRunningActivities?(t.find(".status").text(this.activities[0].status()),t.addClass("on"),this.indicatorShowing=!0):(t.removeClass("on"),this.indicatorShowing=!0)}},t.Activity=function(){function e(t){this._manager=t,this._running=!1,this._status="working",this._timeout=null}return e.TIMEOUT=1e4,e.prototype.start=function(e){var n=this;return this._timeout=setTimeout(function(){return n.end()},t.Activity.TIMEOUT),this._running=!0,this._status=e,this._manager.update()},e.prototype.end=function(){return this._timeout&&clearTimeout(this._timeout),this._running=!1,this._manager.update()},e.prototype.status=function(t){return null==t&&(t=null),t&&(this._status=t,this._manager.update()),this._status},e.prototype.isRunning=function(){return this._running},e}(),t.Bar=function(){function e(e,n){var r=this;this.el=e,this.options=null!=n?n:{},this.el=$(this.el),this.searchField=this.el.find("input.search"),this.resultsEl=this.el.find(".downpour"),this.query=new t.Query(this,this.searchTerm()),this.results=[],this.lastSearch="",this.bindEvents(),this.currentResultIndex=0,this.updateTimer=null,$(document).ready(function(){return r.onLoad()})}return e.prototype.onLoad=function(){return this.options.query&&this.forceSearchTerm(this.options.query),this.bindEvents(),this.focusSearchField()},e.prototype.bindEvents=function(){var t=this;return this.searchField.on("keyup",function(){return t.considerUpdate()}),this.searchField.on("change",function(){return t.considerUpdate()}),Mousetrap.bind("up",this.closeModalAnd(function(){return t.moveUp()})),Mousetrap.bind("down",this.closeModalAnd(function(){return t.moveDown()})),Mousetrap.bind("esc",this.closeModalOr(function(){return t.reset()})),Mousetrap.bind(["enter","tab"],this.closeModalOr(function(){return t.triggerAction()}))},e.prototype.closeModalOr=function(e){return function(){return t.Modal.hasOpenModal()?t.Modal.close():e(),!1}},e.prototype.closeModalAnd=function(e){return function(){return t.Modal.hasOpenModal()&&t.Modal.close(),e(),!1}},e.prototype.focusSearchField=function(){var t=this;return $(document).ready(function(){return t.searchField.focus()})},e.prototype.forceSearchTerm=function(t){return this.searchField.val(t),this.update(!0)},e.prototype.reset=function(){return this.forceSearchTerm("")},e.prototype.searchTerm=function(){return this.searchField.val()},e.prototype.result=function(t){var e,n=this;return this.results.push(t),e=$.parseHTML(t.render()),this.resultsEl.append(e),$(e).click(function(){return n.triggerAction(t)}),this.updateSelection(),this.updateHeight(),this.el.addClass("has-results")},e.prototype.considerUpdate=function(){var t=this;return this.updateTimer&&clearTimeout(this.updatetimer),this.searchTerm().split(" ")>1?setTimeout(function(){return t.update()},300):this.update()},e.prototype.update=function(e){return null==e&&(e=!1),this.updateTimer=null,this.searchTerm()===this.activeSearch&&e===!1?!0:(this.wipe(),this.activeSearch=this.searchTerm(),this.query=new t.Query(this,this.searchTerm()),this.query.run(),!0)},e.prototype.wipe=function(){return this.results=[],this.currentResultIndex=0,this.query.cancel(),this.resultsEl.html(""),this.el.removeClass("has-results"),this.updateHeight()},e.prototype.moveUp=function(){return 0!==this.currentResultIndex?(this.currentResultIndex--,this.updateSelection()):void 0},e.prototype.moveDown=function(){return this.currentResultIndex<this.results.length-1?(this.currentResultIndex++,this.updateSelection()):void 0},e.prototype.updateSelection=function(){var t;return t=this.resultsEl.find(".result"),t.removeClass("selected"),$(t.get(this.currentResultIndex)).addClass("selected")},e.prototype.updateHeight=function(){var t,e,n,r,i;for(e=0,i=this.resultsEl.children(),n=0,r=i.length;r>n;n++)t=i[n],e+=$(t).outerHeight();return this.resultsEl.height(e)},e.prototype.triggerAction=function(t){return null==t&&(t=this.results[this.currentResultIndex]),t?t.triggerAction(this):void 0},e}(),e=function(){var e,n,r,i,o;e={},o=t.actions,i=function(t){return e[t]='function() { return {name:"'+t+'", args:Array.prototype.slice.apply(arguments)} }'};for(r in o)n=o[r],i(r);return e},t.BOLT_API=WWRPC.defineProtocol({log:WWRPC.remote(function(t){return console.log(t)}),utils:{sanitize:WWRPC.local(function(t){return t.replace(/<\/?[a-z0-9]+>/gi,"")}),truncate:WWRPC.local(function(t,e){return t.slice(0,e)}),prefixMatch:WWRPC.local(t.utils.prefixMatch),unescape:WWRPC.local(function(t){return t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")})},command:WWRPC.pass(function(){return this.query.command}),meta:WWRPC.pass(function(){return this.bolt.metadata}),bolts:WWRPC.pass(function(){var e,n,r,i;r={installed:{}},i=t.bolts;for(n in i)e=i[n],r.installed[e.id]=e.metadata;return r}),result:WWRPC.remote(function(t){return this.query.result(t,this.bolt.isPrivileged)}),perform:WWRPC.remote(function(e){return t.actions[e.name].apply(this.bolt,e.args)(this.query.bar),this.query.bar.reset()}),actions:e(),http:{getJSON:WWRPC.remote(function(e,n){return t.activity("downloading",function(r){return t.Vault.get(e,function(t){return r.end(),n(t)})})})},options:WWRPC.local(function(t){var e,n,r,i,o;if(this._tokenDepth=(this._tokenDepth||0)+1,r=command.tokens[this._tokenDepth],command.hasQuery){i=[];for(e in t)n=t[e],r===e?i.push(n.action()):utils.prefixMatch(command.tokens[1],e)?i.push(result({title:n.title,description:n.description,action:actions.fillCommand(command.keyword,e)})):i.push(void 0);return i}o=[];for(e in t)n=t[e],o.push(result({title:n.title,description:n.description,action:actions.fillCommand(command.keyword,e)}));return o}),bolt:{run:WWRPC.local(function(t){return this._run=t}),install:WWRPC.local(function(t){return this._install=t}),uninstall:WWRPC.local(function(t){return this._uninstall=t})}}),t.Bolt=function(){function e(e,n,r){this.url=e,this.source=n,this.isPrivileged=null!=r?r:!1,this.id=t.idFromURL(this.url),this.code=this.source,this.worker=null,this.metadata={},this.processMetadata(),this.set("url",this.url),this.stripCode(),this.compile()}return e.prototype.getKeyword=function(){return this.metadata.keyword},e.prototype.processMetadata=function(){var t,e,n,r,i,o,s;for(s=this.code.split(/\n/g),i=0,o=s.length;o>i;i++){if(e=s[i],n=e.match(/^(\/\/|#)\s+(\w+):\s?(.+?)$/),!n)return;t=n[2],r=n[3],this.set(t,r)}},e.prototype.set=function(t,e){return this.metadata[t]=e},e.prototype.process=function(e){return e.command.hasKeyword&&e.command.keyword===this.getKeyword()?this.run(e):e.result({title:this.metadata.name,description:this.metadata.description,action:t.actions.fillKeyword(this.metadata.keyword)})},e.prototype.stripCode=function(){return this.code=this.code.replace(/^(\n|\/\/.+?\n)/gm,"")},e.prototype.compile=function(){return this.url.search(/\.coffee$/i)>0&&(this.code=CoffeeScript.compile(this.code)),this.code="(function() {\n"+this.code+"\n})"},e.prototype.install=function(){return this.execute("install")},e.prototype.uninstall=function(){return this.execute("uninstall")},e.prototype.run=function(t){return this.execute("run",t)},e.prototype.execute=function(e,n){return null==n&&(n={}),this.worker=WWRPC.spawnWorker(t.BOLT_API,{query:n,bolt:this}),this.worker.loadCode(this.code),this.worker.loadCode("(function() { if(typeof bolt._"+e+" === 'function') bolt._"+e+"() })")},e.prototype.terminate=function(){return this.worker?(this.worker.terminate(),this.worker=null):void 0},e}(),t.Command=function(){function t(t){this.text=t,this.tokens=this.text.split(/\s+/g),this.keyword=this.tokens[0],this.hasKeyword=this.text.search(/\s/)>0,this.query=this.text.replace(RegExp("^"+this.keyword+"\\s+"),""),this.hasQuery=this.query&&this.query.length>0}return t}(),t.Modal=function(){function e(e,r){this.template=e,this.options=r,this.onMessage=n(this.onMessage,this),this.content=t.Template.render("modal-"+this.template,this.options),this.el=null,this.isOpen=!1,t.Modal.activeModal=this}return e.activeModal=null,e.hasOpenModal=function(){return t.Modal.activeModal&&t.Modal.activeModal.isOpen},e.close=function(){return t.Modal.activeModal.close()},e.prototype.open=function(){return this.el=$.parseHTML(this.content),$("body").append(this.el),this.isOpen=!0,window.addEventListener("message",this.onMessage,!1)},e.prototype.close=function(){return this.isOpen?($(this.el).remove(),this.isOpen=!1,window.removeEventListener("message",this.onMessage,!1)):void 0},e.prototype.onMessage=function(t){return(t.data="closeModal")?this.close():void 0},e}(),t.Query=function(){function e(e,n){this.bar=e,this.command=new t.Command(n)}return e.prototype.cancel=function(){return t.terminateAll()},e.prototype.run=function(){var e,n,r,i,o,s;s=t.keywords;for(r in s)if(n=s[r],t.utils.fuzzyMatch(this.command.keyword,r))for(i=0,o=n.length;o>i;i++)e=n[i],t.bolts[e].process(this);return null},e.prototype.result=function(e,n){return null==n&&(n=!1),this.bar.result(new t.Result(e,n))},e}(),t.Result=function(){function e(e,n){this.data=null!=e?e:{},this.isPrivileged=null!=n?n:!1,"object"==typeof this.data.action&&(this.data.action=t.actions[this.data.action.name].apply(this,this.data.action.args))}return e.prototype.render=function(){return t.Template.render("result",this.data)},e.prototype.triggerAction=function(t){return"function"==typeof this.data.action?this.data.action.call(this,t):void 0},e}(),t.store={get:function(e,n){var r;return null==n&&(n=null),r=window.localStorage.getItem(t.store.makeKey(e)),null===r?n:JSON.parse(r)},set:function(e,n){return window.localStorage.setItem(t.store.makeKey(e),JSON.stringify(n))},remove:function(e){return window.localStorage.removeItem(t.store.makeKey(e))},makeKey:function(t){return"string"==typeof t?t:t.join(":")}},t.Template={CACHE:{},render:function(e,n){var r;return r=t.Template.get(e),r(n)},get:function(e){return t.Template.CACHE[e]||t.Template.compile(e)},compile:function(e){var n;return n=$("#"+e+"-template").html(),t.Template.CACHE[e]=Handlebars.compile(n),t.Template.CACHE[e]}},t.Vault=function(){function e(e,r){this.url=e,this.callback=r,this.onMessage=n(this.onMessage,this),this.id=""+t.Vault.COUNTER++,this.registerCallback(),this.frame=document.createElement("iframe"),this.frame.setAttribute("src",this.vaultURL()),this.frame.style.width="0px",this.frame.style.height="0px",$("body").append(this.frame)}return e.COUNTER=1,e.PATH=t.env.production?"http://vault.stormbar.net/vault.html":"/vault.html",e.get=function(e,n){return new t.Vault(e,n)},e.prototype.registerCallback=function(){return window.addEventListener("message",this.onMessage,!1)},e.prototype.vaultURL=function(){return""+t.Vault.PATH+"#"+this.id+"|"+this.url},e.prototype.onMessage=function(t){return t.data.vault&&t.data.id===this.id?(this.callback(t.data.response),this.cleanup()):void 0},e.prototype.cleanup=function(){return $(this.frame).remove(),window.removeEventListener("message",this.onMessage,!1)},e}()}).call(this);